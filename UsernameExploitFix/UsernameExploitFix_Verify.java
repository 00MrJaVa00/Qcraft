package pw.qcraft.qcraft.usernames.exploit.fix;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.nio.charset.Charset;
import java.util.ArrayList;

import org.apache.logging.log4j.core.Filter.Result;
import org.bukkit.craftbukkit.libs.jline.internal.Log;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerPreLoginEvent;

import pw.qcraft.qcraft.Arraylists.ArrayListManager;
import pw.qcraft.qcraft.Core.Main;

public class UsernameExploitFix_Verify implements Listener {
	private Main main;
	public UsernameExploitFix_Verify(Main main) {
		this.main = main;
	}	
	private UsernameExploitFix UsernameExploitFix;
	public UsernameExploitFix_Verify(UsernameExploitFix UsernameExploitFix) {
		this.UsernameExploitFix = UsernameExploitFix;
	}
	private ArrayListManager arm;
	public UsernameExploitFix_Verify(ArrayListManager arm) {
		this.arm = arm;
	}
	ArrayList<String> usrfix = arm.Username_FIX;
	@EventHandler
	public void onJoinCheck(AsyncPlayerPreLoginEvent e) {
		String p = e.getName();
		//Check for unix strings
		try {
			String API = "https://mcapi.de/api/user/" + p;
    		URLConnection connection = new URL(API).openConnection();
            connection.setRequestProperty("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.95 Safari/537.11");
            connection.connect();
            BufferedReader r  = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charset.forName("UTF-8")));
            StringBuilder sb = new StringBuilder();
            String line;
            while ((line = r.readLine()) != null) {
               sb.append(line);
            }
            String value = sb.toString();
            if (value.contains("true")) {
            	return;
            } else {
            	if (usrfix.contains(p)) {
            		Log.info("[Qcraft] - " + p + " Passed Username Exploit");
            		return;
            	}
            	Log.info("[Qcraft] - " + p + " Failed Username Exploit (Auto ban enabled)");
            	usrfix.add(p);
            }
            		  }
            	          catch(IOException ex) {
            	        	  return;
            	          }
	}
}
